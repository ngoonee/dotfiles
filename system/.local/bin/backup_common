#!/bin/bash

if [ "$(basename $0)" = "backup_common" ]; then
  echo "Please run the backup script using the backup_uni/back_home symlinks"
  exit 1
elif [[ $EUID -ne 0 ]]; then
  echo "You must be a root user" 2>&1
  exit 1
fi

function process_warn {
    if [[ $( pgrep -f $1 ) ]]; then
        echo "$1 should not be running during backup, please exit it now." 2>&1
    fi
}

function check_browsers {
    # firefox
    process_warn firefox
    # chromium
    process_warn chromium
    # qutebrowser
    process_warn qutebrowser
    # opera
    process_warn opera
    # maxthon
    process_warn maxthon
}

function disable_services {
    systemctl stop dropbox@ngoonee
    systemctl stop nextcloud-client@ngoonee
}

function enable_services {
    systemctl start dropbox@ngoonee
    systemctl start nextcloud-client@ngoonee
}

check_browsers
disable_services
sleep 1

export BORG_PASSPHRASE=5qmQNoZPravcNjeTp07kbUcS
if [ "$(basename $0)" = "backup_home" ]; then
    echo "Backing up Envy"
    echo "Backing up /etc"
    borg create -s -p borg@home_laptop:/mnt/WD3TB/repos/envy::{hostname}-etc-{now} /etc
    echo "Bacing up /home/ngoonee"
    su ngoonee -c "borg create -s -p --exclude-from /home/ngoonee/.local/conf/excludehome borg@home_laptop:/mnt/WD3TB/repos/envy::{hostname}-home-{now} /home/ngoonee"
elif [ "$(basename $0)" = "backup_test" ]; then
    echo "Testing backup of /etc"
    borg create -n --list borg@home_laptop:/mnt/WD3TB/repos/envy::{hostname}-etc-{now} /etc
    echo "Testing backup of /home/ngoonee"
    su ngoonee -c "borg create -n --list --exclude-from /home/ngoonee/.local/conf/excludehome borg@home_laptop:/mnt/WD3TB/repos/envy::{hostname}-home-{now} /home/ngoonee"
elif [ "$(basename $0)" = "backup_uni" ]; then
    echo "Not implemented yet"
elif [ "$(basename $0)" = "backup_asus" ]; then
    echo "Backing up ASUS"
    echo "Backing up /etc"
    borg create -s -p borg@home_laptop:/mnt/WD3TB/repos/asus::{hostname}-etc-{now} /etc
    echo "Turn on maintenance mode"
    sudo -u http php /usr/share/webapps/nextcloud/occ maintenance:mode --on
    echo "Syncing the data"
    borg create -s -p borg@home_laptop:/mnt/WD3TB/repos/asus::{hostname}-nextcloud-data-{now} /var/nextcloud/data
    echo "Syncing the config"
    borg create -s -p borg@home_laptop:/mnt/WD3TB/repos/asus::{hostname}-nextcloud-config-{now} /etc/webapps/nextcloud/config
    echo "Dumping PostgreSQL"
    pg_dump nextcloud -h localhost -U nextcloud -f /var/nextcloud/nextcloud-dbbackup.bak
    echo " Syncing the SQL backup"
    borg create -s -p borg@home_laptop:/mnt/WD3TB/repos/asus::{hostname}-nextcloud-db-{now} /var/nextcloud/nextcloud-dbbackup.bak
    echo "Turn off maintenance mode"
    sudo -u http php /usr/share/webapps/nextcloud/occ maintenance:mode --off
else
    echo "Please run the backup script using the backup_uni/back_home symlinks"
fi

enable_services

exit 0

sleep 1

if [ "$(basename $0)" = "backup_home" ]; then
  rsync -rlptoD --progress --delete --log-file=/tmp/backuprootlog --modify-window=1 -e 'ssh -p 16484' /etc/ home_laptop_for_backup:/mnt/WD3TB/oonee/etc/
  su ngoonee -c "rsync -rlptoD --exclude-from '/home/ngoonee/.local/conf/excludehome' --progress --delete --log-file=/tmp/backupdatalog --modify-window=1 -e 'ssh -p 16484' /home/ngoonee/ home_laptop_for_backup:/mnt/WD3TB/oonee/ngoonee/"
elif [ "$(basename $0)" = "backup_uni" ]; then
  BASE="192.168.37.88:/mnt/UNIBACKUP"
  BASE="/home/mounts/UniBackup"
  echo "Trying etc"
  #rsync -rlptoD --progress --delete --modify-window=1 /etc/ ${BASE}/etc/
  rsync -rlptoD --no-i-r --info=progress2 --delete --modify-window=1 /etc/ ${BASE}/etc/
  echo "Trying data"
  #su ngoonee -c "rsync -rlptoD --exclude-from '/home/conf/excludedata' --progress --delete --modify-window=1 /home/data/ ${BASE}/data/"
  su ngoonee -c "rsync -rlptoD --exclude-from '/home/conf/excludedata' --no-i-r --info=progress2 --delete --modify-window=1 /home/data/ ${BASE}/data/"
  echo "Trying home"
  #su ngoonee -c "rsync -rlptoD --exclude-from '/home/conf/excludehome' --progress --delete --modify-window=1 /home/ ${BASE}/home/"
  su ngoonee -c "rsync -rlptoD --exclude-from '/home/conf/excludehome' --no-i-r --info=progress2 --delete --modify-window=1 /home/ ${BASE}/home/"
elif [ "$(basename $0)" = "backup_test" ]; then
  echo "Testing settings"
  rsync -nrlptoD --progress --delete --log-file=/tmp/backuprootlog --modify-window=1 -e 'ssh -p 16484' /etc/ home_laptop:/mnt/WD3TB/oonee/etc/
  su ngoonee -c "rsync -nrlptoD --exclude-from '/home/ngoonee/.local/conf/excludehome' --progress  --delete --log-file=/tmp/backupdatalog --modify-window=1 -e 'ssh -p 16484' /home/ngoonee/  home_laptop:/mnt/WD3TB/oonee/ngoonee/"
else
  echo "Please run the backup script using the backup_uni/back_home symlinks"
fi

enable_services
