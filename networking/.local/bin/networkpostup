#!/bin/bash
# First argument is either enp4s0 or wlp3s0
if [ -n "${1:-1}" ]; then
  if grep -q wlp3s0 /proc/net/route; then
    INTERFACE=wlp3s0
  else
    if grep -q enp4s0 /proc/net/route; then
      INTERFACE=enp4s0
    fi
  fi
else
  INTERFACE=$1
fi
    
# Check for current network IP address, used to start cntlm in UTAR network
ip_addr=`ip addr show dev $INTERFACE | grep "inet " | sed 's|.*\(inet \)\(.*\)\/.*|\2|'`
if echo "$ip_addr" | grep -qs "192\.168\.37\..*" ; then
  # We're in UTAR
  systemctl start cntlm.service || true &
  echo http://127.0.0.1:3128 > /home/conf/.current_proxy
  ln -sf /home/conf/proxy.pac.utar /home/conf/proxy.pac
  echo UTAR Proxy Set Up
  # Note, for dropbox's sake needs to have http:// in front of the host
elif echo "$ip_addr" | grep -qs "192\.168\.21\..*" ; then
  # We're in UTAR
  systemctl start cntlm.service || true &
  echo http://127.0.0.1:3128 > /home/conf/.current_proxy
  ln -sf /home/conf/proxy.pac.utar /home/conf/proxy.pac
  echo UTAR Proxy Set Up
  # Note, for dropbox's sake needs to have http:// in front of the host
elif echo "$ip_addr" | grep -qs "192\.168\.68\..*" ; then
  su ngoonee -c "/home/ngoonee/bin/crclient -u noe -i enp4s0"
elif echo "$ip_addr" | grep -qs "192\.168\.18\..*" ; then
  su ngoonee -c "/home/ngoonee/bin/crclient -u noe -i enp4s0"
elif echo "$ip_addr" | grep -qs "192\.168\.8\..*" ; then
  su ngoonee -c "/home/ngoonee/bin/crclient -u noe -i enp4s0"
else
  # We're not
  echo -n > /home/conf/.current_proxy
  ln -sf /home/conf/proxy.pac.direct /home/conf/proxy.pac
  echo Disabling proxy
fi

export http_proxy=`cat /home/conf/.current_proxy`
export https_proxy=`cat /home/conf/.current_proxy`
export ftp_proxy=`cat /home/conf/.current_proxy`

systemctl start ntpd.service || true &
wget --timeout=10 -4qO - http://checkip.eurodyndns.org | grep "Current IP Address" | awk '{print $4}' | su ngoonee -c "tee /home/conf/my_ip" || true &

exit 0
